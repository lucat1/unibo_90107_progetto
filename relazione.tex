\documentclass[a4paper,11pt]{article}
\usepackage[utf8]{inputenc}
\usepackage[italian]{babel}
\usepackage{tabularx}
\usepackage{hyperref}
\usepackage{graphicx}

\usepackage{listings}
\usepackage{inconsolata}
\lstset{
  basicstyle=\footnotesize\ttfamily,
  breakatwhitespace=false,
  breaklines=true,
  % commentstyle=\color{dkgreen},
  deletekeywords={...},
  escapeinside={\%*}{*)},
  extendedchars=true,
  % frame=single,
  keepspaces=true,
  language=SQL,
  otherkeywords={EXISTS},
  morekeywords={*,MODIFY,text,serial,...},
  % keywordstyle=\keywordcheck,
  % identifierstyle=\setidcolor,
  % ew
  tabsize=4
}

\title{Progetto Database: organizzatore eventi}
\author{Luca Bassi, Gabriele Genovese, Gianmaria Rovelli, Luca Tagliavini}
\date{Dicembre 2022}

\begin{document}

\maketitle

\tableofcontents

\section{Analisi dei requisiti}

\subsection{Requisiti espressi in linguaggio naturale}

Vogliamo realizzare un database per un'azienda di organizzazione di eventi e spettacoli, che comprende la gestione dei biglietti, dei luoghi e del personale necessario alla realizzazione.
Un artista è rappresentato come un nome. Uno spettacolo è rappresentato da un titolo, un artista, dal costo della SIAE e da un chacet. Uno spettacolo è una serie di eventi e di ogni evento vogliamo memorizzare il titolo, il luogo, la data di inizio e fine, oltre allo spettacolo al quale è associato. L'azienda può organizzare gli eventi in infrastrutture diverse (palazzetti, stadi, fiere, parchi pubblici, etc...) di conseguenza serve memorizzare un luogo di cui specificare un nome, un tipo (rappresentato da un nome), le coordinate e un prezzo giornaliero per l'affitto. Un luogo potrebbe avere posti (a sedere o in piedi) più convenienti o confortevoli per vendere biglietti a prezzo più alto, quindi rappresentiamo un settore di un luogo con la sua capienza, un nome e collegandolo a un luogo. Un posto di un settore viene identificato da una codice (che è una coppia riga e colonna). Il prezzo dei biglietti associati a un settore di un luogo può variare a seconda dell'evento. Ogni biglietto è quindi rappresentato da un posto a sedere e un evento. Infine, vogliamo tenere traccia di tutti i servizi erogati dall'azienda (maschere, facchini, biglietteria, sicurezza) e richiesti dagli artisti (tecnico delle luci e del suono). Il tipo di un servizio è rappresentato da un nome e da una descrizione. Il fornitore di un servizio è rappresentato dal tipo e da un prezzo all'ora.

\subsection{Glossario dei termini}

\begin{tabularx}{\textwidth}{|X|>{\raggedright\arraybackslash}X|X|>{\raggedright\arraybackslash}X|}
\hline
\textbf{Termine} & \textbf{Descrizione} & \textbf{Sinonimi} & \textbf{Collegamenti}\\
\hline
Evento & La singola data di uno spettacolo o di un concerto & Event & Spettacolo, Luogo, Settore, Biglietto, Servizio\\
\hline
Spettacolo & L'insieme di eventi di un determinato artista & Concerto, Show & Evento, Artista\\
\hline
Artista & Singola persona o gruppo di persone che esegue uno spettacolo & Artist & Spettacolo\\
\hline
Luogo & Edificio, piazza o parco (privato/pubblico) nel quale si organizza uno spettacolo & Location, Venue & Evento, Settore\\
\hline
Settore & Le parti in cui sono suddivisi i posti in un luogo & Sector & Evento, Luogo, Posto\\
\hline
Posto & Posto (a sedere o in piedi) in un settore & Seat & Settore, Biglietto\\
\hline
Biglietto & Il biglietto di ingresso per un evento & Ticket & Evento, Posto\\
\hline
Servizio & Un servizio richiesto per un evento & Service & Evento, Fornitore\\
\hline
Fornitore & Un fornitore di servizi & Provider & Servizio\\
\hline
\end{tabularx}

\subsection{Eliminazione delle ambiguità presenti}
TODO: capire se necessario


\subsection{Strutturazione dei requisiti}

\subsubsection*{Frasi di carattere generale}

Vogliamo realizzare un database per un'azienda di organizzazione di eventi e spettacoli, che comprende la gestione dei biglietti, dei luoghi e del personale necessario alla realizzazione.

\subsubsection*{Frasi relative agli artisti}

Un artista è rappresentato come un nome.

\subsubsection*{Frasi relative agli spettacoli e agli eventi}

Uno spettacolo è una serie di eventi e di ogni evento vogliamo memorizzare il titolo, il luogo, la data di inizio e fine, oltre allo spettacolo al quale è associato.

\subsubsection*{Frasi relative ai luoghi}

L'azienda può organizzare gli eventi in infrastrutture diverse (palazzetti, stadi, fiere, parchi pubblici, etc...) di conseguenza serve memorizzare un luogo di cui specificare un nome, un tipo (rappresentato da un nome), le coordinate e un prezzo giornaliero per l'affitto.

\subsubsection*{Frasi relative ai settori}

Un luogo potrebbe avere posti (a sedere o in piedi) più convenienti o confortevoli per vendere biglietti a prezzo più alto, quindi rappresentiamo un settore di un luogo con la sua capienza, un nome e collegandolo a un luogo.

\subsubsection*{Frasi relative ai posti}

Un posto di un settore viene identificato da una codice (che è una coppia riga e colonna).

\subsubsection*{Frasi relative ai biglietti}

Il prezzo dei biglietti associati a un settore di un luogo può variare a seconda dell'evento. Ogni biglietto è quindi rappresentato da un posto a sedere e un evento.

\subsubsection*{Frasi relative ai servizi}

Infine, vogliamo tenere traccia di tutti i servizi erogati dall'azienda (maschere, facchini, biglietteria, sicurezza) e richiesti dagli artisti (tecnico delle luci e del suono). Il tipo di un servizio è rappresentato da un nome e da una descrizione.

\subsubsection*{Frasi relative ai fornitori}

Il fornitore di un servizio è rappresentato dal tipo e da un prezzo all'ora.

\subsection{Specifica operazioni}

\begin{enumerate}
    \item Inserire un artista (in media 10 volte all'anno)
    \item Inserire uno spettacolo (in media 35 volte all'anno)
    \item Inserire un fornitore di servizi (in media 5 volte all'anno)
    \item Inserire un luogo suddiviso in settori (in media 3 volte all'anno)
    \item Inserire un evento (in media 50 volte all'anno)
    \item Prenotare un servizio (in media 200 volte all'anno)
    \item Vendere un biglietto (in media 30 000 volte all'anno)
    \item Rimborsare un biglietto (in media 300 volte l'anno)
    \item Inserire un entità che offre un servizio (in media 20 volte all'anno)
    \item Trovare un biglietto dato il posto (in media 28 000 volte all'anno)
    \item Visualizzare tutti gli eventi di un artista (in media 50 000 all'anno)
    \item Visualizzare tutti gli eventi di uno spettacolo (in media 10 000 all'anno)
    \item Visualizzare le spese di un evento (in media 50 volte all'anno)
    \item Visualizzare gli incassi di un evento (in media 50 volte all'anno)
    \item Visualizzare i guadagni di un evento (in media 50 volte all'anno)
    \item Visualizzare il numero di posti liberi di un determinato evento (in media 1000 volte l'anno)
    \item Visualizzare la percentuale media di biglietti venduti da un determinato artista (in media 100 volte l'anno)
    \item Visualizzare quali eventi hanno fatto sold out (in media 50 volte l'anno)
    \item Visualizzare gli eventi presenti in un arco temporale
    \item Visualizzare tutti gli eventi che si svolgeranno in un determinato luogo
    \item Visualizzare lo spettacolo che ha guadagnato di più nell'ultimo periodo
\end{enumerate}

\section{Progettazione concettuale}

\subsection{Identificazione delle entità e relazioni}

Abbiamo identificato le seguenti entità: evento, spettacolo, artista, luogo, tipologia di luogo, settore, posto, biglietto, servizio, fornitore.

Possiamo dividere le entità in quattro gruppi:

\begin{itemize}
    \item Spettacolo e artista.
    \item Servizio e fornitore.
    \item Luogo, tipologia di luogo, settore, posto.
    \item Biglietto.
\end{itemize}

\subsection{Un primo scheletro dello schema}

A un livello di astrazione più alto abbiamo un evento, parte di uno spettacolo di un artista, che si svolge in un luogo, di cui vengono venduti i biglietti e in cui ci sono dei fornitori che offrono dei servizi.

 \includegraphics[width=\textwidth]{ERScheletro.png}
 
\subsection{Sviluppo delle componenti dello scheletro}

\subsubsection*{Spettacolo e artista}

Abbiamo poi sviluppato lo spettacolo come un'entità con un titolo, un cachet, un costo SIAE ed è composto da vari eventi, ognuno con un titolo, un inizio e una fine.\\
Un evento è composto da un solo spettacolo.\\
Ogni spettacolo è eseguito da un artista che ha un nome, un artista può eseguire più spettacoli.

 \includegraphics[width=\textwidth]{ERSpettacoloArtista.png}

\subsubsection*{Fornitore}

Ogni fornitore può offrire servizi a più eventi e ogni evento può avere più fornitori di servizi, i servizi sono di diverse tipologie.\\
Ogni fornitore può fornire vari tipi di servizi e ogni evento può aver necessità di diversi tipi di servizi.

 \includegraphics[width=\textwidth]{ERFornitore.png}

\subsubsection*{Luogo, tipologia di luogo, settore, posto}

Ogni luogo ha un nome, delle coordinate geografiche e un costo di affitto.\\
In ogni evento si svolge in un luogo e un luogo può ospitare più eventi.\\
Ogni luogo ha una categoria.\\
Ogni luogo è diviso in settori.
Ogni settore ha un nome (che è univoco all'interno del luogo), una capienza massima e un prezzo dei biglietti per ogni evento.\\
In ogni settore sono presenti dei posti segnati con una lettera e un numero (univoci all'interno del loro settore).

 \includegraphics[width=\textwidth]{ERLuogo.png}

\subsubsection*{Biglietto}

Di ogni evento vendiamo diversi biglietti, ma ogni biglietto è valido per un solo evento.
Ogni biglietto ha un ID e un nominativo.

 \includegraphics[width=\textwidth]{ERBiglietto.png}

\subsection{Unione delle componenti nello schema finale ridotto}

Ogni biglietto è associato a un posto.

 \includegraphics[width=\textwidth]{ER.png}

\subsection{Dizionario dei dati}

\subsubsection*{Entità}

\begin{tabularx}{\textwidth}{|X|>{\raggedright\arraybackslash}X|>{\raggedright\arraybackslash}X|>{\raggedright\arraybackslash}X|}
\hline
\textbf{Nome} & \textbf{Descrizione} & \textbf{Attributi} & \textbf{Identificatori}\\
\hline
Artista & Un artista che esegue degli spettacoli & & Nome (stringa)\\
\hline
Spettacolo & Un serie di eventi di un artista & Title (stringa), Cachet (float), costo SIAE (float) & ID (numero)\\
\hline
Tipo di luogo & La tipologia di luogo (es. edificio, piazza, parco...) & & Nome (stringa)\\
\hline
Luogo & Il luogo dove si svolge un evento & Prezzo (float) & Nome (stringa) e coordinate (point)\\
\hline
Evento & Una singola data di uno spettacolo & Titolo (stringa), Data e ora di inizio (timestamp) e fine (timestamp) & ID (numero)\\
\hline
Settore & Un settore di un luogo & Capacità (numero) & Nome (stringa) e \textit{luogo} (riferimento)\\
\hline
Posto & Un posto in un settore & & Fila (carattere), numero (numero) e \textit{settore} (riferimento)\\
\hline
Tipo di servizio & La tipologia di servizio offerto & & Nome (stringa)\\
\hline
Fornitore & Un fornitore di servizi & Descrizione (stringa) & Nome (stringa)\\
\hline
Biglietto & Il biglietto di ingresso per un evento & Nominativo (stringa) & ID (numero)\\
\hline
\end{tabularx}

\subsubsection*{Relazioni}

\begin{tabularx}{\textwidth}{|X|>{\raggedright\arraybackslash}X|>{\raggedright\arraybackslash}X|>{\raggedright\arraybackslash}X|}
\hline
\textbf{Nome} & \textbf{Descrizione} & \textbf{Attributi} & \textbf{Entità coinvolte}\\
\hline
Esegue & Associa un artista a uno spettacolo & & Artista (0,N), Spettacolo (1,1)\\
\hline
Compone & Associa un evento con uno spettacolo & & Evento (1,1), Spettacolo (1,N)\\
\hline
Tenersi & Associa un evento a un luogo & & Evento (1,1), Luogo (1,N)\\
\hline
Tipo luogo & Associa un luogo a una tipologia & & Luogo (1,1), Tipo (1,N)\\
\hline
Diviso & Associa un settore a un luogo & & Luogo (1,N), Settore (1,1)\\
\hline
Composto & Associa un posto a un settore & & Settore(1,N), Posto (1,1)\\
\hline
Costa & Associa un settore a un evento & Prezzo & Evento (1,N), Settore (1,N)\\
\hline
Vende & Associa un biglietto a un evento & & Evento (1,N), Biglietto (1,1)\\
\hline
& Associa un biglietto a un posto & & Biglietto (1,1), Posto (1,N)\\
\hline
Servizio & Associa un tipo di servizio a un fornitore e a un evento & Costo & Tipo (1,N), Fornitore (1,N), Evento (1,N)\\
\hline
\end{tabularx}

\subsection{Regole aziendali}

\textbf{Vincoli}

\begin{itemize}
    \item Il cachet e il costo della SIAE devono essere maggiori o uguali a zero.
    \item Il costo di affitto del luogo deve essere maggiore o uguale a zero.
    \item La capacità di un settore deve essere maggiore di 0.
    \item Il prezzo di un settore deve essere maggiore di 0.
    \item Il costo di un servizio deve essere maggiore di 0.
    \item Il numero di posti in un settore è pari alla capacità.
\end{itemize}

\textbf{Derivazioni}

\begin{itemize}
    \item Il prezzo di un biglietto è il costo del settore in cui si trova il posto del biglietto.
    \item Il costo di un evento è la somma tra il cachet e il costo SIAE per l'affitto, il costo di affitto del luogo e i costi dei servizi.
    \item Il guadagno di un evento è la somma dei prezzi dei biglietti venduti.
\end{itemize}

\section{Progettazione logica}

\subsection{Tavole dei volumi e delle operazioni}

\subsubsection*{Tavole dei volumi}

\begin{tabularx}{\textwidth}{|X|>{\raggedright\arraybackslash}X|>{\raggedright\arraybackslash}X|}
\hline
\textbf{Concetto} & \textbf{Tipo} & \textbf{Volume}\\
\hline
Artista & E & 200 \\
\hline
Spettacolo & E & 600\\
\hline
Luogo & E & 100\\
\hline
Evento & E & 1000\\
\hline
Settore & E & 600\\
\hline
Posto & E & 3600\\
\hline
Fornitore & E & 100 \\
\hline
Biglietto & E & 40000\\
\hline
Servizio & R & 5000\\
\hline
Costo & R & 6000\\
\hline
\end{tabularx}


\subsection{Ristrutturazione dello schema concettuale}

\subsection{Normalizzazione}

\subsection{Traduzione verso il modello relazionale}

\section{Codice SQL}

\subsection{Definizione dello schema}
\lstinputlisting{schema.sql}

\subsection{Codifica delle operazioni}
Alcune interrogazioni sono state inserite, anche se non sono presenti 
nella specifica delle operazioni, perché utili alla comprensione o perché
compongono le interrogazioni successive.

\begin{quote}
  NB: i \texttt{...} si riferiscono ad un input dato da un utente o da
  un applicazione.
\end{quote}

\subsubsection{Inserire un artista}
\lstinputlisting{queries/insert-artist.sql}

\subsubsection{Inserire uno spettacolo}
\lstinputlisting{queries/insert-show.sql}

\subsubsection{Inserire un ente che offre servizi}
\lstinputlisting{queries/insert-service-provider.sql}

\subsubsection{Inserire un luogo}
\lstinputlisting{queries/insert-venue.sql}

\subsubsection{Inserire un settore per un luogo}
\lstinputlisting{queries/insert-sector.sql}

\subsubsection{Inserire una posto in un settore}
\lstinputlisting{queries/insert-sector-seat.sql}

\subsubsection{Inserire un evento}
\lstinputlisting{queries/insert-event.sql}

\subsubsection{Dare un prezzo ad un settore per un evento}
\lstinputlisting{queries/insert-sector-event-price.sql}

\subsubsection{Prenotare un dato servizio per un evento}
\lstinputlisting{queries/insert-service-provider-event.sql}

\subsubsection{Vendere un biglietto}
\lstinputlisting{queries/insert-ticket.sql}

\subsubsection{Rimborsare un biglietto}
Visto che teniamo in memoria solo i biglietti acquistati, ``rimborsare'' un
biglietto corrisponde ad eliminare il biglietto dalla tabella \texttt{tickets}.
\lstinputlisting{queries/delete-ticket.sql}

\subsubsection{Trovare un biglietto dato il posto}
\lstinputlisting{queries/search-ticket-by-seat.sql}

\subsubsection{Cercare tutti gli eventi a cui partecipa un artista}
Si vogliono selezionare i titoli e il nome del luogo di tutti gli eventi a cui
partecipa un dato artista.
\lstinputlisting{queries/search-events-by-artist.sql}

\subsubsection{Cercare tutti gli show di un artista}
Si vogliono selezionare i nomi di tutti gli show tenuti da un dato artista.
\lstinputlisting{queries/search-shows-by-artist.sql}

\subsubsection{Visualizzare tutti gli eventi di uno spettacolo}
\lstinputlisting{queries/search-events-by-show.sql}

\subsubsection{Visualizzare le spese di un evento}
Si vogliono mostrare tutte le spese dato un evento: i costi dei diritti SIAE e del
cachet dell'artista, il costo dell'affitto del luogo e tutti i costi relativi ai
servizi necessari.
\lstinputlisting{queries/search-expenses-by-event.sql}

\subsubsection{Visualizzare gli incassi totali di un evento}
\lstinputlisting{queries/search-incoming-by-event.sql}

\subsubsection{Visualizzare i guadagni di un evento}
Questa interrogazione non è altro che la differenza tra le spese e gli incassi di un evento.
\lstinputlisting{queries/search-earnings-by-event.sql}

\subsubsection{Visualizzare tutti i posti per un evento}
Si vogliono mostrare tutti i posti $(riga, colonna)$ per un dato evento.
\lstinputlisting{queries/search-seats-by-event.sql}

\subsubsection{Visualizzare tutti i posti prenotati per un evento}
Si vogliono mostrare tutti i posti $(riga, colonna)$ \textbf{prenotati} per un dato evento.
\lstinputlisting{queries/search-booked-seats-by-event.sql}

\subsubsection{Visualizzare tutti i posti liberi per un evento}
Si vogliono mostrare tutti i posti $(riga, colonna)$ \textbf{liberi} per un dato evento.
\lstinputlisting{queries/search-free-seats-by-event.sql}

\begin{quote}
  Nota: entrambi i \texttt{...} si riferiscono allo \emph{stesso} \texttt{id}
  dell'evento in questione.
\end{quote}

In alternativa, per avere un leggero miglioramento delle performance\footnote{
Vedi dati empirici su \href{https://stackoverflow.com/a/66785790}{StackOverflow}.
Sarebbe opportuno verificare quanto riportato sul proprio dataset.} si pu\`o
ottenere lo stesso risultato tramite un \texttt{NOT EXISTS}:
\lstinputlisting{queries/search-free-seats-by-event-ne.sql}

\subsubsection{Visualizzare la percentuale di biglietti venduti per evento}
Si vuole mostrare la percentuale di biglietti venduti per un singolo evento.
\lstinputlisting{queries/percentage-sold-tickets-by-event.sql}

\begin{quote}
  Nota: entrambi i \texttt{...} si riferiscono allo \emph{stesso} \texttt{id}
  dell'evento in questione.
\end{quote}

\subsubsection{Visualizza percentuale media di biglietti venduti per artista}
Si vuole mostrare la percentuale media di tutti i biglietti venduti per ogni
eventoper dato un singolo artista.
\lstinputlisting{queries/mean-percentage-sold-tickets-by-artist.sql}

\subsubsection{Visualizzare eventi hanno fatto sold out}
Si vogliono mostrare il nome degli eventi che hanno fatto sold out.
\lstinputlisting{queries/search-sold-out-events.sql}
 
\subsubsection{Visualizzare gli eventi per data}
Si vuole mostrare l'elenco di tutti gli eventi che si svolgono un range di date.
\lstinputlisting{queries/search-events-by-date.sql}

\begin{quote}
  Nota: i due \texttt{...} presenti si riferiscono ad un \emph{diverso} \texttt{input}.
\end{quote}

\subsubsection{Visualizzare gli eventi per luogo}
Si vuole mostrare l'elenco di tutti gli eventi che si svolgono in un determinato luogo.
\lstinputlisting{queries/search-events-by-venue.sql}

\subsubsection{Visualizzare i guadagni dato uno show}
Si vuole mostrare il guadagno di un singolo show.
\lstinputlisting{queries/search-earnings-by-show.sql}

\subsubsection{Visualizzare lo show che ha guadagnato di più degli altri}
Si vuole mostrare il guadagno pi\`u alto raggiunto da uno show e il suo titolo.
\lstinputlisting{queries/show-max-earnings.sql}

\section{Esempi di interrogazioni}

\end{document}
